# Coding guidelines

Here are some consistency guidelines.

## Formatting

Use `.clang-format` and note a few things:

* Put trailing commas wherever possible.
* Separate separate function difinitions or any types of definition blocks with 2 empty lines.

## Documenting

* Use any doc comments (even empty ones, `/** */`) for any objects you want to appear in the docs.
* Wrap doc comments with `/** `..` */` or `/**`*\<newline\>*..*\<newline\>*`*/`
  and indent every line inside the comment:
    ```c
    /** One-line comment. */
    void foo(void);

    /**
        Multi-line comment.
        Multi-line comment.
    */
    void foo(void);
    ```
* Wrap file-level doc comments with `/**`*\<newline\>*..*\<newline\>*`*///`
  and indent every line inside the comment:
    ```c
    /**
        This file does foo.
        It also does bar.
    *///
    ```

## Naming

| Prefix | Meaning                   |
| ------ | ------------------------- |
| `out_` | Output function parameter |
| `on_`  | Event callback function.  |

| Suffix         | Meaning                                                              |
| -------------- | -------------------------------------------------------------------- |
| `_fn_t`        | Function typedef                                                     |

## Errors

Fallible function example:

```c
fj_err_t do_something_or_return_error(void)
{
    create_x();

    FJ_TRY (do_something_with_x_or_return_error()) {
        destroy_x();
        return fj_result; // defined implicitly by FJ_TRY
    }

    do_something_else_with_x();

    return FJ_OK;
}
```

## More coding

Use Fejix base types, memory allocation and utils.

See:
* [fejix/core/base.h](../../include/fejix/core/base.h)
* [fejix/core/alloc.h](../../include/fejix/core/alloc.h)
* [fejix/core/utils.h](../../include/fejix/core/utils.h)

**TODO: Finish docs.**


## API design

### Return types and errors

Because all interface functions must have a callable default implemention and all default
implementations are generated automatically, all functions must return one of the following:
* ``void`` (the default return value is not generated)
* ``fj_err_t`` (the default return value is ``FJ_ERR_UNSUPPORTED``)
* a numeric value e.g. representing flags (the default value is ``0``)

For any other return types the automatic code generator may fail to generate reasonable defaults
that compile reliably without warnings.

If a function needs to return a value of another type, it must do so with an output parameter
and return either ``void`` or ``fj_err_t``.

Returning ``void`` in such case is sufficient if e.g. the returned object is retrieved
from an input object parameter, whose constructor function returns ``fj_err_t``. Example:
```c
/* If unimplemented, this returns FJ_ERR_UNSUPPORTED without touching the arguments. */
fj_err_t fj_xxx_create(struct xxx **out_xxx);

/* To call this, the user MUST make sure that xxx was created successfully. */
void fj_xxx_get_yyy(struct xxx *xxx, struct yyy **out_yyy);
```

### Extending interfaces

When extending interfaces in minor releases, extra steps must be taken in order to make the
autogenerated code happy.

If you want to add some extra functionality to interface ``fejix/interface/foo.h`` in version
``X.Y.Z``, the code must go to ``fejix/interface/foo-x-vX.Y.Z.h`` and
``#include``d in the original header.

This is done in order not to break existing code.
Existing implementations that do not yet implement that extension, a default implementation for the
new header is generated. An implementation that implements the extension simply needs to replace
the default source file.
